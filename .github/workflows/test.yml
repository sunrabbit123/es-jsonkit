name: ğŸ§ª Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: ğŸ§ª ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]
    steps:
      - name: ğŸ“¥ ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“¦ Node.js ${{ matrix.node-version }} ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¥ ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          echo "ğŸ§ª Vitestë¡œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."
          npm run test:coverage

      - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "ğŸ“Š í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì™„ë£Œ"
          echo "Node.js ë²„ì „: ${{ matrix.node-version }}"

      - name: ğŸ“¤ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ (Node.js 20ë§Œ)
        if: matrix.node-version == 20
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ
        if: success()
        run: |
          echo "âœ… Node.js ${{ matrix.node-version }}ì—ì„œ ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í–ˆìŠµë‹ˆë‹¤!"

      - name: âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨
        if: failure()
        run: |
          echo "âŒ Node.js ${{ matrix.node-version }}ì—ì„œ ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          echo "ğŸ”§ ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”."

  test-summary:
    name: ğŸ“‹ í…ŒìŠ¤íŠ¸ ìš”ì•½
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - name: ğŸ“‹ ì „ì²´ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
        run: |
          echo "ğŸ“‹ ëª¨ë“  Node.js ë²„ì „ì—ì„œì˜ í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "âœ… ëª¨ë“  Node.js ë²„ì „(18, 20, 22)ì—ì„œ í…ŒìŠ¤íŠ¸ í†µê³¼!"
          else
            echo "âŒ ì¼ë¶€ Node.js ë²„ì „ì—ì„œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          fi
